#!/bin/busybox ash
# (c) Robert Shingledecker 2012
. /etc/init.d/tc-functions
useBusybox
checkroot
BUILD=`getBuild`
TCEDIR=/etc/sysconfig/tcedir

setupStartupScript() {
	[ -d usr/local/tce.installed ] || mkdir -p usr/local/tce.installed
	chmod 775 usr/local/tce.installed
	chown root.staff usr/local/tce.installed
}


fetchDeb() {
	wget ${MIRROR}/${1}
	if [ "$?" != 0 ]
	then
		echo "failed on download of $1"
		echo "$1" >> /tmp/import.log
		selectDeb ${1}
	fi
}

selectDeb() {
	FULLPATH=${1}
	SELECT_PATH="${FULLPATH%/*}"
	PKG="${1##*/}"
	wget -q -O - "$MIRROR"/"$SELECT_PATH" | awk 'BEGIN{FS=" href="}{print $2}' | awk 'BEGIN{FS="\""}{print $2}' | grep "^${PKG%%_*}" | grep ".deb$" | select "Select Package for ${PKG}" "-"
	read DEB < /tmp/select.ans
	if [ "$DEB" != "q" ]
	then
		fetchDeb ${SELECT_PATH}/${DEB}
	fi
}


cleanup() {
	rm -rf /tmp/work
	chmod 777 /tmp
	chmod 775 /usr/local/tce.installed
	chmod 775 /usr/local/tce.icons 2>/dev/null
	chgrp staff /usr/local/tce.installed
	chgrp staff /usr/local/tce.icons 2>/dev/null
}

# Main
unset ONBOOT ONDEMAND FILE
while getopts bo OPTION
do
	case ${OPTION} in
		b) ONBOOT=TRUE ;;
		o) ONDEMAND=TRUE ;;
		*) exit 1 ;;
	esac
done
shift `expr $OPTIND - 1`

if [ -z "$1" ]
then
	echo "you must specify a target."
	exit 1
fi
TARGET="$1"

debGetEnv "$2" || exit 1
read DEBINX < /tmp/debinx
DEBINX="/etc/sysconfig/tcedir/$DEBINX"
echo "Using Package Index: $DEBINX"
read MIRROR < /tmp/debmirror
echo "Using Debian Mirror: $MIRROR"
echo
unset META
#RESULTS="$(debQuery "$TARGET")"
#if [ ! "$RESULTS" ]
if sudo grep -q "$TARGET:" /tmp/.pkgprebuilt; then
  echo "$TARGET is a dCore premade package"
  META="$TARGET"

elif [ -s /tmp/.targetfile ]; then
  echo "$TARGET is from your own custom package list."
  META="$TARGET"

elif sudo grep -q "$TARGET:" /tmp/.depfile && ! sudo grep "^Package: $TARGET" "$DEBINX" > /dev/null 2>&1; then
  echo "$TARGET is a meta package of related Debian ones."
  META="$TARGET"
elif sudo grep "^Package: $TARGET" "$DEBINX" > /dev/null 2>&1; then
 echo "$TARGET is a standard Debian package."

else
  echo "$TARGET is not a standard Debian, dCore precompiled, or meta package, exiting.."
  cleanup 
  exit 1
fi




echo -n "Proceed to create $TARGET.sce? (y/N): "
read ans
[ "$ans" == "y" ] || exit 1

> /var/log/sce.log
[ -d "$TCEDIR"/sce ] || mkdir "$TCEDIR"/sce
[ -d "$TCEDIR"/import ] || mkdir "$TCEDIR"/import
cd "$TCEDIR"/import
#[ -f exclude.lst ] || gzip -dc /tmp/deb2sce.xlst.gz > exclude.lst

[ -d "$TARGET" ] || mkdir "$TARGET"
cd "$TARGET"
> /tmp/import.log	

if [ -s /tmp/.targetfile ]; then
    for I in `cat /tmp/.targetfile`; do 
      debGetDeps "$I"
    done
else
    debGetDeps "$TARGET"
fi
if [ -f /tmp/.importsecure ]; then
   mkdir -p usr/local/importmd5sum
fi

HERE=`pwd`
for DEBINFO in `ls -t /tmp/work`; do
	 
	
	 
	 read FULLPATH < /tmp/work/"$DEBINFO"

	 if grep "^${DEBINFO}:" /tmp/.pkgprebuilt >/dev/null; then
	 	read IMPORTMIRROR < /opt/tcemirror                                                                             
	 	PREBUILTMIRROR="${IMPORTMIRROR%/}/$(getMajorVer).x/"$BUILD"/import"
		IMPORTMIRROR="${IMPORTMIRROR%/}/$(getMajorVer).x/import"
		if wget -sq "$PREBUILTMIRROR"/"${DEBINFO}".tar.gz; then
		  [ -f "$TCEDIR"/import/"${DEBINFO}".tar.gz ] && rm "$TCEDIR"/import/"${DEBINFO}".tar.gz
	 	  wget -O "$TCEDIR"/import/"${DEBINFO}".tar.gz "$PREBUILTMIRROR"/"${DEBINFO}".tar.gz
		  [ -f "$TCEDIR"/import/"${DEBINFO}".tar.gz.md5.txt ] && rm "$TCEDIR"/import/"${DEBINFO}".tar.gz.md5.txt
		  wget -O "$TCEDIR"/import/"${DEBINFO}".tar.gz.md5.txt -q "$PREBUILTMIRROR"/"${DEBINFO}".tar.gz.md5.txt	
		fi
		  [ -f /tmp/"${DEBINFO}.deb2sce" ] && rm /tmp/"${DEBINFO}.deb2sce"
		  wget -O /tmp/"${DEBINFO}.deb2sce" -q "$PREBUILTMIRROR"/"${DEBINFO}.deb2sce" 2>/dev/null		
		if [ -f /tmp/"${DEBINFO}.deb2sce" ]
		then
			echo "Merging Tiny Core custom start script for ${DEBINFO}: "${DEBINFO}.deb2sce""
			setupStartupScript
			cat /tmp/"${DEBINFO}.deb2sce" > usr/local/tce.installed/"${DEBINFO}"
			chmod -R 775 usr/local/tce.installed/
			chown -R root.staff usr/local/tce.installed/
			rm /tmp/"${DEBINFO}.deb2sce"
		fi
  	 	cd "$TCEDIR"/import
		if [ -f "${DEBINFO}".tar.gz.md5.txt ] && md5sum -c "${DEBINFO}".tar.gz.md5.txt >/dev/null
  	 	then
		  if [ -f /tmp/.importsecure ]; then
			echo "${DEBINFO}: `cat "${DEBINFO}".tar.gz.md5.txt | cut -f1 -d" "`" >> "$TCEDIR"/import/"$TARGET"/usr/local/importmd5sum/"$TARGET".md5sum
			
		  fi
			echo "Merging "${DEBINFO}":"
    	   		  tar xf "$TCEDIR"/import/"${DEBINFO}".tar.gz -C "$TCEDIR"/import/"$TARGET"
           		  rm "$TCEDIR"/import/"${DEBINFO}".tar.gz
		elif [ -f "${DEBINFO}".tar.gz.md5.txt ] && ! md5sum -c "${DEBINFO}".tar.gz.md5.txt >/dev/null
		then
			echo "md5sum failed for "${DEBINFO}".tar.gz, exiting.."
			cleanup
			exit 1
		fi	
		cd "$TCEDIR"/import/"$TARGET"


	 elif [ "$FULLPATH" != "" ]; then
	 	fetchDeb "$FULLPATH"
	 	THISDEB="${FULLPATH##*/}"
		sudo debExtract "$THISDEB"
		if [ "$?" != "0" ]; then
		  echo "Failure to extract "$THISDEB", exiting.."
		  cleanup
		  exit 1
		fi
		if [ -f /tmp/.importsecure ] && [ -f /tmp/"$DEBINFO".md5sum ]; then
			echo ""$DEBINFO": `cat /tmp/"$DEBINFO".md5sum`" >> usr/local/importmd5sum/"$TARGET".md5sum
			sudo rm /tmp/"$DEBINFO".md5sum
		fi
		sudo rm "$THISDEB"

	 fi
done

[ -f /tmp/.importsecure ] && rm /tmp/.importsecure

cd ..
sed -i "s:APPNAME:$TARGET:g" "$TARGET"/usr/local/tce.installed/* > /dev/null 2>&1
mksquashfs "$TARGET" "$TARGET".sce
if [ "$?" == "0" ]
then
	mv "$TARGET".sce "$TCEDIR"/sce/.
	sudo rm -rf "$TARGET"
	if [ "$ONBOOT" ]
	then
		if ! grep -wq "$TARGET" "$TCEDIR"/sceboot.lst
		then
			echo "$TARGET" >> "$TCEDIR"/sceboot.lst
		fi
	fi
	[ "$ONDEMAND" ] && ondemand "$TARGET"
	echo "Done."
else
	echo "Failed."
fi

cleanup
