#!/bin/busybox ash
# (c) Jason Williams 2015

. /etc/init.d/tc-functions

TCEDIR=/etc/sysconfig/tcedir
SCEDIR="$TCEDIR/sce"
echo 0 > /tmp/.debpurgedsize
checknotroot
sudo chown "$TCUSER":staff /tmp
sudo chmod 1777 /tmp
BUILD=`getBuild`
if [ "$BUILD" == "x86" ]; then
	DEBBUILD="i386"
elif [ "$BUILD" == "armv7" ]; then
	DEBBUILD="armhf"
fi

if [ "$1" == "-h" ] || [ "$1" == "--help" ]; then
	echo " "
	echo "${YELLOW}sce-debpurge - purge deprecated, unneeded or all DEB (Debian package files)"
	echo "               and *.tar.gz files from /etc/sysconfig/tcedir/import/debs.${NORMAL}"
	echo " "
	echo "Usage:"
	echo " "
	echo "${YELLOW}'"sce-debpurge"'${NORMAL}     update DEBINX files (Debian Index files located in /etc/"
        echo "                   sysconfig/tcedir/import/debinx), purge deprecated DEBs."
	echo "${YELLOW}'"sce-debpurge -p"'${NORMAL}  preserve local DEBINX files, purge deprecated DEBs"
        echo "                   based on current index."
	echo "${YELLOW}'"sce-debpurge -a"'${NORMAL}  purge all files from /etc/sysconfig/tcedir/import/debs,"
        echo "                   including *.deb and *.tar.gz, note purged files will"
        echo "                   need to be re-downloaded to rebuild SCEs during"
        echo "                   updates or re-imports."
	echo "${YELLOW}'"sce-debpurge -n"'${NORMAL}  purge files in /etc/sysconfig/tcedir/import/debs not needed"
	echo "                   to update or re-import any existing system SCEs."
	echo " "
exit 1
fi

[ -f /tmp/.debpurgelist ] && sudo rm /tmp/.debpurgelist
[ -f /tmp/.debpurged ] && sudo rm /tmp/.debpurged
[ -f /tmp/.deblist ] && sudo rm /tmp/.deblist


if [ -f /tmp/.scelock ]; then
	LOCK=`cat /tmp/.scelock`
	if /bb/ps | /bb/grep "$LOCK" | /bb/grep -v grep > /dev/null 2>&1; then
		echo "Another SCE utility is presently in use, exiting.."
		exit 1
	fi
fi

echo "$$" > /tmp/.scelock

while getopts pan OPTION
do
	case ${OPTION} in
		n) NOTNEEDED=TRUE ;;
		p) PRESERVEDEBINXMODE=TRUE ;;
		a) PURGEALL=TRUE ;;
		*) echo "Run  sce-debpurge --help  for usage information."
                   exit 1 ;;
	esac
done

shift `expr $OPTIND - 1`

if ls /etc/sysconfig/tcedir/import/debs/*.deb > /dev/null 2>&1 ||  ls /etc/sysconfig/tcedir/import/debs/*.tar.gz > /dev/null 2>&1; then
	:
else
        echo " "
	echo "No packages to be removed, exiting.."
	exit 0
fi

if [ "$PURGEALL" == "TRUE" ]; then
        echo " "
	echo "Warning: This will purge all files from /etc/sysconfig/tcedir/import/debs."
        echo " "
        echo "Although this will not affect the function of installed SCEs, some files will"
        echo "need to be re-downloaded later to rebuild SCEs during updates or re-imports."
        echo " "
        echo -n "Press Enter to proceed, Ctrl-C aborts: "
        read ans
	echo " "
        cd /etc/sysconfig/tcedir/import/debs
	if ls *.deb > /dev/null 2>&1; then
		for I in `ls *.deb`; do
			ls -l "$I" | cut -f5 -d" " >> /tmp/.debpurgedsize
			echo "Removing "$I"..."
			sudo rm "$I"
			echo "$I" >> /tmp/.debpurged
		done
	fi
	if ls *.tar.gz > /dev/null 2>&1; then
		for I in `ls *.tar.gz`; do
			ls -l "$I" | cut -f5 -d" " >> /tmp/.debpurgedsize
			echo "Removing "$I"..."
			sudo rm "$I"
			echo "$I" >> /tmp/.debpurged
		done
	fi
        echo " "
	echo "All files purged from /etc/sysconfig/tcedir/import/debs."
	DPURGESIZEFINAL=$(echo `awk 'BEGIN{total=0};{total += $1};END{print total/1024/1024}' /tmp/.debpurgedsize` | awk '{printf("%.2f\n", $1)}')
        echo
	echo "Total space freed by removing unneeded files: "$DPURGESIZEFINAL" MB"
	exit 0
fi

if [ "$NOTNEEDED" == "TRUE" ]; then
echo " "
echo "Checking for unneeded DEB files..."
	for I in `ls "$SCEDIR"/*.sce`; do
		E=`basename "$I" .sce`
		debPurge "$E"
	done
	ls /etc/sysconfig/tcedir/import/debs/ | cut -f1 -d_ | sed 's:.tar.gz::' | sed 's:-data::' | sort | uniq > /tmp/.debpurgelist
	for I in `cat /tmp/.debpurgelist`; do 
			grep "^$I$" /tmp/.deblist > /dev/null 2>&1 && sed -i "/^$I$/d" /tmp/.debpurgelist
	done
        cd /etc/sysconfig/tcedir/import/debs
	for I in `cat /tmp/.debpurgelist`; do		
		if ls "$I"_*deb > /dev/null 2>&1; then
			ls -l "$I"_*deb | cut -f5 -d" " >> /tmp/.debpurgedsize
			echo "Removing "$I"_*deb..."
			sudo rm "$I"_*deb
			echo "$I" >> /tmp/.debpurged
		fi
		if ls "$I"*.tar.gz > /dev/null 2>&1; then
			ls -l "$I"*.tar.gz | cut -f5 -d" " >> /tmp/.debpurgedsize
			echo "Removing "$I"*.tar.gz..."
			sudo rm "$I"*.tar.gz
			echo "$I" >> /tmp/.debpurged	
		fi
		
	done
	
        echo " "
	echo "All unneeded files purged from /etc/sysconfig/tcedir/import/debs."
	DPURGESIZEFINAL=$(echo `awk 'BEGIN{total=0};{total += $1};END{print total/1024/1024}' /tmp/.debpurgedsize` | awk '{printf("%.2f\n", $1)}')
        echo
	echo "Total space freed by removing unneeded files: "$DPURGESIZEFINAL" MB"
	exit 0
fi


getName() {
> /tmp/"$1".pkglist
sudo grep -B 1 -A 10 "^Package: $1$" "$DEBINX" |  grep -B10 "^$" > /tmp/"$1".pkglist
DEBINX=/tmp/"$1".pkglist
getName1 $1
rm /tmp/"$1".pkglist
}

getName1() {
	awk -v package="Package: $1" -v build="$DEBBUILD" '
	BEGIN {
		RS=""
		FS="\n"
	}
	{
		if ($1 == package) {
			for (i=2; i <= NF; i++) {
				split($i,f,": ")
			
		
				if ( f[1] == "Architecture" ) {
					if ( f[2] == "all" )
						{}
					else if ( f[2] == build )
						{}
					else
						break
					}
		
				if ( f[1] == "Filename" )
					print f[2]
						    
			
		}


		}
		
	} ' < "$DEBINX"


}


#echo " "
#echo -n "This tool will remove all non current packages in /etc/sysconfig/tcedir/import/debs?\
#  Do you want to continue? (y/N):"
#read ans
#if [ "$ans" == "y" ] || [ "$ans" == "Y" ]; then
#	:
#else
#	echo "Exiting.."
#	exit 1
#fi

> /tmp/.debpurged

if [ "$PRESERVEDEBINXMODE" != "TRUE" ]; then
	echo " "
	sudo debGetEnv
	if [ "$?" != "0" ]; then
		echo "Error updating DEBINX files, exiting.."
		exit 1
	fi
fi

if [ "$PRESERVEDEBINXMODE" = "TRUE" ]; then
	echo " "
	echo "Preserving local DEBINX..."
	[ -s /etc/sysconfig/tcedir/import/debinx/debinx ] || sudo debGetEnv "$2"
	if [ "$?" != "0" ]; then
		echo "Error updating DEBINX files, exiting.."
	fi
fi

echo " "
echo "Checking for deprecated DEB files..."

read IMPORTMIRROR < /opt/tcemirror
PREBUILTMIRROR="${IMPORTMIRROR%/}/dCore/"$BUILD"/import"
IMPORTMIRROR="${IMPORTMIRROR%/}/dCore/import"
read DEBINX_SECURITY < /etc/sysconfig/tcedir/import/debinx/debinx_security
DEBINX_SECURITY="/etc/sysconfig/tcedir/import/debinx/"$DEBINX_SECURITY""


cd /etc/sysconfig/tcedir/import/debs
if ls *.deb > /dev/null 2>&1; then
 for I in `ls *.deb`; do
 DEBINFO=`echo "$I" | cut -f1 -d_`

    if sudo grep "^Package: $DEBINFO$" "$TCEDIR"/import/debinx/debinx.* > /dev/null 2>&1 ; then
	DEBINX=`sudo grep "^Package: $DEBINFO$" "$TCEDIR"/import/debinx/debinx.* /dev/null | head -n 1 | cut -f1 -d:`		
	NAMENEW=$(getName1 "$DEBINFO")
	NAMENEW="${NAMENEW##*/}"
	NAMEOLD="$I"
	if [ "$NAMENEW" != "$NAMEOLD" ]; then
		echo "Removing "$NAMEOLD"..."
		ls -l "$NAMEOLD" | cut -f5 -d" " >> /tmp/.debpurgedsize
		sudo rm "$NAMEOLD"
		echo "$I" >> /tmp/.debpurged
	else
		: #echo ""$DEBINFO" package files are up to date."
	fi			
    elif sudo grep "^Package: $DEBINFO$" "$DEBINX_SECURITY" > /dev/null 2>&1 ; then
	DEBINX="$DEBINX_SECURITY"	
	NAMENEW=$(getName "$DEBINFO")
	NAMENEW="${NAMENEW##*/}"
	NAMEOLD="$I"
	if [ "$NAMENEW" != "$NAMEOLD" ]; then
		echo "Removing "$NAMEOLD"..."
		ls -l "$NAMEOLD" | cut -f5 -d" " >> /tmp/.debpurgedsize
		sudo rm "$NAMEOLD"
		echo "$I" >> /tmp/.debpurged
	else
		: #echo ""$DEBINFO" package files are up to date."
	fi	
    else
 	read DEBINX < /etc/sysconfig/tcedir/import/debinx/debinx
	DEBINX="/etc/sysconfig/tcedir/import/debinx/$DEBINX"	
	NAMENEW=$(getName "$DEBINFO")
	NAMENEW="${NAMENEW##*/}"
	NAMEOLD="$I"
	if [ "$NAMENEW" != "$NAMEOLD" ]; then
		echo "Removing "$NAMEOLD"..."
		ls -l "$NAMEOLD" | cut -f5 -d" " >> /tmp/.debpurgedsize
		sudo rm "$NAMEOLD"
		echo "$I" >> /tmp/.debpurged
	else
		: #echo ""$DEBINFO" package files are up to date."
	fi
    fi

 done
fi
if ls *.tar.gz > /dev/null 2>&1; then
 for I in `ls *.tar.gz`; do
	DEBINFO=`echo "$I" | sed 's:-data.tar.gz::' | sed 's:.tar.gz::'`
	if grep "$DEBINFO:" "$DEBINXDIR"/PREBUILTMD5SUMLIST > /dev/null 2>&1; then
		MD5OLD=$(/bb/md5sum "$I" | cut -f1 -d" ")
		MD5NEW=$(grep "$DEBINFO:" "$DEBINXDIR"/PREBUILTMD5SUMLIST | cut -f2 -d" ")
		if [ "$MD5NEW" != "$MD5OLD" ]; then
			echo "Removing "$I"..."
			ls -l "$I" | cut -f5 -d" " >> /tmp/.debpurgedsize
			sudo rm "$I"
			echo "$I" >> /tmp/.debpurged
		elif [ ! -n "$MD5NEW" ] || [ ! -n "$MD5OLD" ]; then
			echo "Md5sum data for "$I" cannot be found, leaving in place."
			sleep 1
		else
			: #echo ""$DEBINFO" package files are up to date."
		fi
	elif grep "$DEBINFO:" "$DEBINXDIR"/PKGDATAFILEMD5SUMLIST > /dev/null 2>&1; then
		MD5OLD=$(/bb/md5sum "$I" | cut -f1 -d" ")
		MD5NEW=$(grep "$DEBINFO:" "$DEBINXDIR"/PKGDATAFILEMD5SUMLIST | cut -f2 -d" ")
		if [ "$MD5NEW" != "$MD5OLD" ]; then
			echo "Removing "$I"..."
			ls -l "$I" | cut -f5 -d" " >> /tmp/.debpurgedsize
			sudo rm "$I"
			echo "$I" >> /tmp/.debpurged
		elif [ ! -n "$MD5NEW" ] || [ ! -n "$MD5OLD" ]; then
			echo "Md5sum data for "$I" cannot be found, leaving in place."
			sleep 1
		else
			: #echo ""$DEBINFO" package files are up to date."
		fi
	fi
 done
fi

echo " "
echo "All non current packages removed from /etc/sysconfig/tcedir/import/debs."
DPURGESIZEFINAL=$(echo `awk 'BEGIN{total=0};{total += $1};END{print total/1024/1024}' /tmp/.debpurgedsize` | awk '{printf("%.2f\n", $1)}')
echo " "
echo "Total space freed by removing unneeded files: "$DPURGESIZEFINAL" MB"
exit 0
