#!/bin/sh
# (c) Jason Williams 2015

. /etc/init.d/tc-functions

TCEDIR=/etc/sysconfig/tcedir

checknotroot
sudo debGetEnv

getMd5sum() {
> /tmp/"$1".pkglist
sudo grep -B 1 -A 8 "^Package: $1$" "$DEBINX" |  grep -B8 "^$" > /tmp/"$1".pkglist
sudo grep "^MD5sum:" /tmp/"$1".pkglist | cut -f2 -d" " 
rm /tmp/"$1".pkglist
}

getMd5sum1() {
	awk -v package="Package: $1" -v build="$DEBBUILD" -v FIELD="$1: "  '
	BEGIN {
		RS=""
		FS="\n"
	}
	{
		if ($1 == package) {
			for (i=2; i <= NF; i++) {
				split($i,f,": ")

				if ( f[1] == "Architecture" ) {
					if ( f[2] == "all" )
						{}
					else if ( f[2] == build )
						{}
					else
						break
					}
				
				if ( f[1] == "MD5sum" )
					print f[2] 
			}
		
		}
		
	} ' < "$DEBINX"
}
echo " "
echo " "
echo "This tool will remove all non current packages in /etc/sysconfig/tcedir/import/debs?"
echo -n "Do you want to continue? (y/N):"
read ans
if [ "$ans" == "y" ] || [ "$ans" == "Y" ]; then
	:
else
	echo "Exiting.."
	exit 1
fi


cd /etc/sysconfig/tcedir/import/debs

for I in `ls *.deb`; do
DEBINFO=`echo "$I" | cut -f1 -d_`

    if sudo grep "^Package: $DEBINFO$" "$TCEDIR"/debinx.* > /dev/null 2>&1 ; then
	DEBINX=`sudo grep "^Package: $DEBINFO$" "$TCEDIR"/debinx* /dev/null | head -n 1 | cut -f1 -d:`		
	MD5NEW=$(getMd5sum1 "$DEBINFO")
	MD5OLD=$(/bb/md5sum "$I" | cut -f1 -d" ")
	if [ -n "$MD5NEW" ] && [ -n "$MD5OLD" ] && [ "$MD5NEW" != "$MD5OLD" ]; then
		echo "Removing "$I".."
		sudo rm "$I"
	
	else	
		echo ""$DEBINFO" package files are up to date."
	fi			
    else
	read DEBINX < /tmp/debinx
	DEBINX="/etc/sysconfig/tcedir/$DEBINX"	
	MD5NEW=$(getMd5sum "$DEBINFO")
	MD5OLD=$(/bb/md5sum "$I" | cut -f1 -d" ")
	if [ -n "$MD5NEW" ] && [ -n "$MD5OLD" ] && [ "$MD5NEW" != "$MD5OLD" ]; then
		echo "Removing "$I".."
		sudo rm "$I"
	else	
		echo ""$DEBINFO" package files are up to date."
	fi	
    fi

done

for I in `ls *.tar.gz`; do
	if grep "$I:" /tmp/PREBUILTMD5SUMLIST; then
		MD5OLD=$(/bb/md5sum "$I" | cut -f1 -d" ")
		MD5NEW=$(grep "$I:" /tmp/PREBUILTMD5SUMLIST | cut -f2 -d:)
		if [ -n "$MD5NEW" ] && [ -n "$MD5OLD" ] && [ "$MD5NEW" != "$MD5OLD" ]; then
			echo "Removing "$I".."
			sudo rm "$I"
		fi
	elif grep "$I:" /tmp/PKGDATAFILEMD5SUMLIST; then
		MD5OLD=$(/bb/md5sum "$I" | cut -f1 -d" ")
		MD5NEW=$(grep "$I:" /tmp/PKGDATAFILEMD5SUMLIST | cut -f2 -d:)
		if [ -n "$MD5NEW" ] && [ -n "$MD5OLD" ] && [ "$MD5NEW" != "$MD5OLD" ]; then
			echo "Removing "$I".."
			sudo rm "$I"
		fi
	fi
done

echo "All non current packages removed from /etc/sysconfig/tcedir/import/debs." 
exit 0







