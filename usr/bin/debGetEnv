#!/bb/ash
# (c) Robert Shingledecker 2012
. /etc/init.d/tc-functions

PATH="/bb:/bin:/sbin:/usr/bin:/usr/sbin"
export PATH

zsyncDebianIndex()
{
	getMirror "$BUILD"
	MIRROR="${MIRROR%/tcz}"
	cd "$TCEDIR"
	if zsync -i "$TCEDIR"/"$DEBINX" "$MIRROR"/"$DEBINX".zsync 2>/dev/null
	then
		rm -f "$DEBINX".zs-old
	else
		wget -O "$TCEDIR"/"$DEBINX" "$MIRROR"/"$DEBINX"
	fi
	cd - > /dev/null
}

unset DEBINX MIRROR
TCEDIR=/etc/sysconfig/tcedir
BUILD="$1"
[ -z "$BUILD" ] && BUILD=`getBuild`
case $BUILD in
armv6 )
	DEBINX=debian-wheezy-all_wheezy_main_armhf_Packages
	zsyncDebianIndex
	MIRROR1=http://archive.raspbian.org/raspbian
	;;
armv7 )
	BINARY=binary-armhf
	DEBINX=debian_wheezy_main_armhf_Packages
	zsyncDebianIndex
	MIRROR1=http://ftp.us.debian.org/debian
	;;
x86 )	
	BINARY=binary-i386
	DEBINX=debian_wheezy_main_i386_Packages
	zsyncDebianIndex
	MIRROR1=http://ftp.us.debian.org/debian
	;;
esac
read MIRROR 2>/dev/null < /opt/debmirror 2>/dev/null || MIRROR="$MIRROR1"

if [ -z "$DEBINX" ]
then
	echo "No Package Index Available"
	exit 1
else
	echo "$DEBINX" > /tmp/debinx
fi

if ls -A /opt/debextra > /dev/null 2>&1; then
	for I in `ls /opt/debextra/`; do
		if [ ! -z $(cat /opt/debextra/"$I" | awk '{print $3}') ]; then
			MIR=`cat /opt/debextra/"$I" | awk '{print $1}'`
			DIST=`cat /opt/debextra/"$I" | awk '{print $2}'`
			REPO=`cat /opt/debextra/"$I" | awk '{print $3}'` 
			F="/dists/"$DIST"/"$REPO"/"$BINARY"/"
			if wget -s "$MIR""$F"/Packages.bz2 > /dev/null 2>&1; then
				wget -q -O - "$MIR""$F"/Packages.bz2 | bunzip2 > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/"$DIST"/"$REPO"/Packages.bz2 > /dev/null 2>&1; then
				wget -q -O - "$MIR"/"$DIST"/"$REPO"/Packages.bz2 | bunzip2 > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/Packages.bz2 > /dev/null 2>&1; then
				echo "Using the repo mirror "$MIR""
			elif wget -s "$MIR""$F"/Packages.gz > /dev/null 2>&1; then
				wget -q -O - "$MIR""$F"/Packages.gz | gunzip > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/"$DIST"/"$REPO"/Packages.gz > /dev/null 2>&1; then
				wget -q -O - "$MIR"/"$DIST"/"$REPO"/Packages.gz | gunzip > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/Packages.gz > /dev/null 2>&1; then
				wget -q -O - "$MIR"/Packages.gz | gunzip > /tmp/debinx."$I"
				echo "Using the repo mirror "$MIR""
			elif wget -s "$MIR""$F"/Packages.gen > /dev/null 2>&1; then
				wget -O /tmp/debinx."$I" -cq "$MIR""$F"/Packages.gen 
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/"$DIST"/"$REPO"/Packages.gen > /dev/null 2>&1; then
				wget -O /tmp/debinx."$I" -cq "$MIR"/"$DIST"/"$REPO"/Packages.gen 
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/Packages.gen > /dev/null 2>&1; then
				wget -O /tmp/debinx."$I" "$MIR"/Packages.gen 
				echo "Using the repo mirror "$MIR""			

			else
				echo " "
				echo -n "WARNING:   Repo "$MIR"  "$DIST"  "$REPO" is unavailable."
				echo " "
				sleep 5
			fi
		else
			MIR=`cat /opt/debextra/"$I" | awk '{print $1}'`
			DIST="wheezy"
			REPO=`cat /opt/debextra/"$I" | awk '{print $2}'` 
			F="/dists/"$DIST"/"$REPO"/"$BINARY"/"
			if wget -s "$MIR""$F"/Packages.bz2 > /dev/null 2>&1; then
				wget -q -O - "$MIR""$F"/Packages.bz2 | bunzip2 > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/"$REPO"/Packages.bz2 > /dev/null 2>&1; then
				wget -q -O - "$MIR"/"$REPO"/Packages.bz2 | bunzip2 > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/Packages.bz2 > /dev/null 2>&1; then
				wget -q -O - "$MIR"/Packages.bz2 | bunzip2 > /tmp/debinx."$I"
				echo "Using the repo mirror "$MIR""
			elif wget -s "$MIR""$F"/Packages.gz > /dev/null 2>&1; then
				wget -q -O - "$MIR""$F"/Packages.gz | gunzip > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/"$REPO"/Packages.gz > /dev/null 2>&1; then
				wget -q -O - "$MIR"/"$REPO"/Packages.gz | gunzip > /tmp/debinx."$I"
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/Packages.gz > /dev/null 2>&1; then
				wget -q -O - "$MIR"/Packages.gz | gunzip > /tmp/debinx."$I"
				echo "Using the repo mirror "$MIR""
			elif wget -s "$MIR""$F"/Packages.gen > /dev/null 2>&1; then
				wget -O /tmp/debinx."$I" -cq "$MIR""$F"/Packages.gen 
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/"$REPO"/Packages.gen > /dev/null 2>&1; then
				wget -O /tmp/debinx."$I" "$MIR"/"$REPO"/Packages.gen 
				echo "Using the repo "$MIR" "$DIST" "$REPO""
			elif wget -s "$MIR"/Packages.gen > /dev/null 2>&1; then
				wget -O /tmp/debinx."$I" -cq "$MIR"/Packages.gen 
				echo "Using the repo mirror "$MIR""
			else
				echo " "
				echo -n "WARNING:   Repo "$MIR" "$DIST" "$REPO" is unavailable."
				echo " "
				sleep 5
			fi
		fi
	done
fi

# Test mirror
if wget -s "$MIRROR" > /dev/null 2>&1; then
	echo "Using the repo "$MIRROR" wheezy main"
	echo "$MIRROR" > /opt/debmirror
else
	echo "The wheezy main repo of mirror "$MIRROR" is not available, exiting.."  
exit 1
fi 
