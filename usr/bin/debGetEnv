#!/bin/busybox ash
# (c) Robert Shingledecker 2012
. /etc/init.d/tc-functions
useBusybox

zsyncDebianIndex()
{
	getMirror "$BUILD"
	MIRROR="${MIRROR%/tcz}"
	cd "$TCEDIR"
	if zsync -i "$TCEDIR"/"$DEBINX" "$MIRROR"/"$DEBINX".zsync 2>/dev/null
	then
		rm -f "$DEBINX".zs-old
	else
		wget -O "$TCEDIR"/"$DEBINX" "$MIRROR"/"$DEBINX"
	fi
	cd - > /dev/null
}

test_mirror() 
{
if wget -s "$MIRROR" > /dev/null 2>&1; then
  echo "Using mirror: "$MIRROR""
else
  echo ""$MIRROR" is not available, exiting.."  
  exit 1
fi 
}

unset DEBINX MIRROR
TCEDIR=/etc/sysconfig/tcedir
BUILD="$1"
[ -z "$BUILD" ] && BUILD=`getBuild`
case $BUILD in
armv6 )
	DEBINX=debian-wheezy-all_wheezy_main_armhf_Packages
	zsyncDebianIndex
	MIRROR1=http://archive.raspbian.org/raspbian
	MIRROR=`cat /opt/debmirror`
	;;
armv7 )
	DEBINX=debian_wheezy_main_armhf_Packages
	zsyncDebianIndex
	MIRROR1=http://ftp.us.debian.org/debian
	MIRROR=`cat /opt/debmirror`
	;;
x86 )
	DEBINX=debian_wheezy_main_i386_Packages
	zsyncDebianIndex
	MIRROR1=http://ftp.us.debian.org/debian
	MIRROR=`cat /opt/debmirror`
	;;
esac






if [ -z "$DEBINX" ]
then
	echo "No Package Index Available"
	exit 1
else
	echo "$DEBINX" > /tmp/debinx
fi

if [ ! -z `cat /opt/debmirror` > /dev/null 2>&1 ]
then
  test_mirror
else
  echo "$MIRROR1" > /opt/debmirror
  test_mirror
fi
