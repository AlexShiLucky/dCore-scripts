#!/bb/ash
# (c) Robert Shingledecker 2012
. /etc/init.d/tc-functions

PATH="/bb:/bin:/sbin:/usr/bin:/usr/sbin"
export PATH
TCEDIR=/etc/sysconfig/tcedir
BUILD=`getBuild`
if [ "$BUILD" == "x86" ]; then
	DEBBUILD="i386"
elif [ "$BUILD" == "armv7" ]; then
	DEBBUILD="armhf"
fi
getDeps() {
	awk -v package="Package: $1" -v build="$DEBBUILD" -v location="/tmp/work/$1" '
	BEGIN {
		RS=""
		FS="\n"
	}
	{
		if ($1 == package) {
			for (i=2; i <= NF; i++) {
				split($i,f,": ")
			
		
				if ( f[1] == "Architecture" ) {
					if ( f[2] == "all" )
						{}
					else if ( f[2] == build )
						{}
					else
						break
					}
			


				if ( f[1] == "Depends" ) {
					jmax = split(f[2],item,",")
					for (j=1; j<=jmax; j++) { 
						kmax = split(item[j],deps," ")
						print( deps[1] )
					}
				}
				if ( f[1] == "Filename" )
					print f[2] > location
						     
			
		}


		}
		
	} ' < "$DEBINX" 


}
[ -s /tmp/debinx ] || debGetEnv "$2"


if [ -z "$1" ]
then
	echo "you must specify a search target."
	exit 1
fi
if ls -A /opt/debextra > /dev/null 2>&1; then

  if grep "Package: "$1"$" /tmp/debinx.* > /dev/null; then
    DEBINX=`grep "^Package: "$1"$" /tmp/debinx* | head -n 1 | cut -f1 -d:`
    DEPS="$(getDeps $1)"
    #[ ! -z "$DEPS" ] && echo " "
    echo "$DEPS"
    exit
  else
    # MIR=`cat /opt/debmirror`
    read DEBINX < /tmp/debinx
    DEBINX="/etc/sysconfig/tcedir/$DEBINX"
    DEPS="$(getDeps $1)"
    [ -z "$DEPS" ] && exit 1
    echo "$DEPS"
  fi
  

else
    #MIR=`cat /opt/debmirror`
    read DEBINX < /tmp/debinx
    DEBINX="/etc/sysconfig/tcedir/$DEBINX"
    DEPS="$(getDeps $1)"
    [ -z "$DEPS" ] && exit 1
    echo "$DEPS"
fi

